/**
 * Zero-Knowledge Protocols for E-Vote (ZKPEV).
 *
 * Copyright Â© 2013, The Norwegian Ministry of Local Government and Regional
 * Development (KRD).
 *
 * This file is part of ZKPEV.
 *
 * ZKPEV is free software: you can redistribute it and/or modify it under the
 * terms of the GNU General Public License as published by the Free Software
 * Foundation, either version 3 of the License, or (at your option) any later
 * version.
 *
 * ZKPEV is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
 * details.
 *
 * You can find a copy of the GNU General Public License in
 * /src/site/resources/gpl-3.0-standalone.html. Otherwise, see also
 * http://www.gnu.org/licenses/.
 */
package com.computas.zkpev2013.mixing;

import com.computas.zkpev2013.ElGamalPublicKeyList;
import com.computas.zkpev2013.ResultsArrayList;
import com.computas.zkpev2013.ResultsList;
import com.computas.zkpev2013.mixing.IncorrectMixingProofIncident;
import com.computas.zkpev2013.mixing.InvalidAuditDataRecordIncident;
import com.computas.zkpev2013.mixing.InvalidMixingDataRecordIncident;
import com.computas.zkpev2013.mixing.MixingVerificationWorker;

import org.apache.commons.codec.binary.Base64;
import static org.testng.Assert.assertFalse;
import static org.testng.Assert.assertTrue;

import org.testng.annotations.BeforeMethod;
import org.testng.annotations.Test;

import java.math.BigInteger;

import java.security.NoSuchAlgorithmException;


/**
 * Integration tests on the MixingVerificationWorker.
 *
 */
public class MixingVerificationWorkerIntegrationTest {
    private static final BigInteger SAMPLE_P = new BigInteger(
            "22519781860318881430187237378393910440433456793106883439191554045609533190204716026094503488051043531257695232100353994296431999733305913289830606623675094806877884255872439714678914992056169353692036021770097223778392105262307803104951171429150982767069700653909195647599098780046724703785991755259095912786508845222597772887203546632493935590809326329822837682361511439054458165467044490658668908755516611075852591340913731324282531411301527453756791057107929172839003743485012313000403534330922416540828874783338650662007436059441348150784982317988527563812882812455109992843656727186872083932493433216403334110087");
    private static final BigInteger SAMPLE_G = new BigInteger(
            "19140805144017540497707786625792286921405966026933054372546212478081606825277100641152753685549997641757412202354820556035283634167831414111680419792323513134593333242130321485704646466132023972092638166348661889738666905149514346301514811888481584122903522192426522565163431677342704016489172931295206771271956675417455593733493182654653217734161457736905965163738973158663182502896276372310802897020170186481607829975539047679142654262779602075975560918037248175928164089234991713304225443874682021320096580809741466636539107495416015820825091232630444699803381650489285110532680106190202164342326569938521995903077");
    private static final BigInteger SAMPLE_H = new BigInteger(
            "15767103161188431726810732547407071177925682470096161113662719329970151989521808605211708980148853646358184785265698288206467886519416824938097511897175394153183299970057910661112235919650701007926207445783398837008410584396746210082523938166164511910717655019379900382402878897548938693825625577255875241671695927055614575927068409397924078583190963658265084557648260898854231641007945637962701179737860118584226735942584888595742172827013353350499066429923853690118418094376964200302533698193066579535824852762698049107984716754445670202902488607524608492482523694573929391910902766007429761724512335207851342013142");
    private static final String SAMPLE_MIXING_UUID = "afc11e1b5e8c47a38a9413c15c8ff502";
    private static final byte[] SAMPLE_INPUT_VOTES = "IWvRkimscLc7ZnzHRhq5HkKtL0XXlMwZEFu2w7iIdSBCWDAKuxgUNPkA66dqZ7OyuvqePFoXVHLgemivhxRHAtkKALAtdc3ihfDN99u3vrfiPinPLHcidemy056uxPO+9mb96Cs4RVhFDY3DnW6BuZQUuITmrBOEhaaxja7qbijKD7SNX2bwqRv0j4GeasLaGosqDfFqEYd9aLr7x7M6xkk4AhyoPHG7qAI/A1SiwDxF2ocycQgJk7kl4yeJDgBKPFw0F3xZ1f8yVJEr6d8Su8OwdXN/NiFlX9bjKifFK2bgMqJvlsAPXLjK5ms/2VeSIE4atuMnZquzJMpjEICHcQ==#GUM3T8tSx72bLMES4Zh4qKeJun1rkd5i9opb7tcA0bk736GIE/pgeYytK2Igo4fZRgfMou81guVfcL4J6/1Wq2s+NNlFil5HU+9OwnJLc0LV2Q8MXvOs/Vex4nBkbMz4BMORlt0w542Rj2LZX2FdWKkQOSIX1d1BKTcvPljLAzpl3QIMSoK86to7+4+hv16ANUZ6wIepS7giTfFfutWv4nvhLLDO4bCrthVg+YTr+F0urssfMNZcM7CyEd8/EHMYhIhfoOGT8wDZN9bPMp0Z1cLbrOw9nm6luEPD0VEjgjHk+enGXsqQuiQ6rnWSGFn+MV9rkYxTwKXOAgBOqVSnXg==#,000018,01,730071,WhV3wkXBpR7hSC7aQ9chNur0/fD8fLi91SLp5XrAnsBSHwQbJKRKiO3sIGPitVcnTTZXR3d9M8wLYLCaJ3GGIaLcLSHeiqDf4PLPZRM/WTUZErbhw1rcqIEgGqyqfVhXFSVAUvAYNmhXnkhYrXw82nEs8v2oBlLs2Eg/zsDn1j1LcA6jyrPhgVmKc3Qixxhn+wCJ/IxDxD6lV/o/0T3HrDjyo2ufeUEJdZVjiYi6EXVF6IWQx4dK5R1CTtvPptV+fegbis421NrVug6yt2Nk55fUJW1kowHyp0EscQGbJosTb/FEHNVI1K8mDcYklSl53+K/9QZLJIEl2JsdBp+upQ==#KhVJEp/GpYr8B6bBR9/P2nl6xdhJ3vejWn5FRUKz0TLSS/Y8h2nUaF6DzPg2NyI3qYl/4b/ykM80DWZYjFky2oDqztLinnHSrLrefBMY3dV+UJYDc1vHs6XnM+4VsAQ6jguquW8km3XtKu3bItafsqnzGvfImbG2TPnswnmJO00rq03qKgOBWv5JZWc3ttN1+/19gxwgpo2WJv8Fevqx5CgYk4nzpPDYqnSEVc1anxKo6j7odBXfPOpgGGqwHek7C82gDqHitZ9pw1Ye8VXQ/qH52gpSrTBamZztyX36dlDSLiwDzRJ83N+sdHEcqy4G/ACAzvv/99L5qaBxMPT8hA==#,000018,01,730071,IWvRkimscLc7ZnzHRhq5HkKtL0XXlMwZEFu2w7iIdSBCWDAKuxgUNPkA66dqZ7OyuvqePFoXVHLgemivhxRHAtkKALAtdc3ihfDN99u3vrfiPinPLHcidemy056uxPO+9mb96Cs4RVhFDY3DnW6BuZQUuITmrBOEhaaxja7qbijKD7SNX2bwqRv0j4GeasLaGosqDfFqEYd9aLr7x7M6xkk4AhyoPHG7qAI/A1SiwDxF2ocycQgJk7kl4yeJDgBKPFw0F3xZ1f8yVJEr6d8Su8OwdXN/NiFlX9bjKifFK2bgMqJvlsAPXLjK5ms/2VeSIE4atuMnZquzJMpjEICHcQ==#TTYm5BNmyn4KwHLv6tiUPWajPOgMLEfI2iC+um2wnYxTL3go1N4cd6e4Ft70gmYovuIa9HAvhTcMdvlAqNSh5oWylb7WoRaI7p3yoQ6s+kwWWTlv3J0UBrpUu4Ez8uOsdn3kD6baDWvqs1Sl20Ty5842T4kPJvBbI6pJEOQxe17ldFpk49bweWYPTXkuKC5Wx38MQ/bT6nocd8uvo8WrxJvRkZl8y/7wa/KqtAZI1WUY6Ry8I2QgZ/8atNBPGlBMTMA63ZwxYl0bLDB1dfdxxYFFFWpRsfHeGvZ3EKDspRas97uCpieU321BB3xthXlICcb6Pz4heHnJX7jGaq24ow==#,000018,01,730071,p1\n".getBytes();
    private static final byte[] SAMPLE_OUTPUT_VOTES = "NTIzODc2NDM3NDEwODYxODY0MTI1NzQ3MDcyNTMxOTM4ODI4MzcxNTI4NjI3MjU5#n#Mzg0Nzc5ODE0NjAzMTI1NjkxODM5MTg1NzUyMjg5OTM5Mjc1Mjg3MjY1NzU2NTQ5#n#MTcxNjYzODI5MDkwNDkzODUyNjM5MzYxNjY3NjY2NjQyNjExODUxNTc1MDg3MDcw#n#Mzc5MjE5MDk1NDY0MTc5MDY4NzAzMDc3Mzc2ODEwMDg4NTkzMzMyMDQ0OTg0MjIy#n#MDYwOTg5MzI2NjMxOTcyNzcxODU2MTE0MTA5MzI4MjM4MDkxNjM1MDk2OTUwMDE3#n#NDUzMzA2OTYyNTk4NzQ3OTk1MDMzNDc2MDc2NTE0MzE0MjgzMDIzNDY0NzcyOTk3#n#ODczMDk2MTU1MTUyNDAyODU3MjE3MDk2NTk5MDQwODI4OTQxNDk2NDg5MjU5NDk3#n#MzE4MDYyNjI3MDY5MTQ1MjgxMjkyNDI4NzcxNzk4NjY4NTM3ODk0MDU5MDg4MzA2#n#NDUxNjAzMzkwMjY4NTg1ODk3MTU2NTE4MTczNDkwNTc5NjM2NTQ3MTA3MDUxMjgy#n#NzY2Mjk0MDEwOTk1MzkwMDU5ODU5NTA3MzM0OTIyODgzMzA1NzkwNjQ4NDExMTUy#n#MjU1ODczOTcwMzI5NzE1OTY5MTc4MjE3NzIxMTI3MzIxMjIxOTQxNjc4NDI5MzM0#n#MjM1NDEwMTg1ODM4MTI1MTQ4NzIwNjgxODQ1MzY1MzgwOTM5MzE1MDM2NzI1NzM5#n#NjExNjg5MzM0NTk4MDIzMjQ5Mzg1NTUyMjgzNDY4OTQzNTY5MzYyMzJ8ODY5OTM0#n#MDc5NDYyMDAyODUwNTEyODQyMjMxNDI4MzUyNjI3NzE1MTc4MzcwMDEwMzg5MTQ5#n#MzQxNjQzNjI1MjYwNDUwMjk3Mjc3Nzg1NDIxMjQwMTI5NzkzNzQ3OTU3NjUzMjQy#n#MTg4MzU4NzU2ODc4NjU1MDUxMTMyODU0NjIyODkyNDEwODgyODM5MTUwOTczNjA1#n#Njk4MTg0NjU2NTM2NDM5NzUzMjUzOTA3NjUxNjM4ODg0NDM0OTE1NDMzNzM3MDIw#n#MDM0ODEyMzkzOTc4NzU3NjQ1MTA5MDkxNjM4ODU1ODc1OTg5NDQ3MDI5MjI5MTky#n#MjYwNjQxMDQyOTk3NjUxNjAzODQ3OTMzMTYyMTUzMzY4MTkwNDU2OTcxNTI2MzA0#n#NzgxMjcwODQyODY2MzA2MDU4MzQ0MTMxNzAyNjkwNjc5ODUyNDIxNDM4MTg3MDg1#n#Njc1ODk1NzQ2MTMyMTcwMDE3MTY5Mzc2NTA4MzA2MTk1NDg1Nzk5NjUxNDUzMzI0#n#NDQwMzkwNTg4MzAyOTQ2NDUxNDg0NzU1MDA1NjMyMTM3Mjc5MzI5Nzc2MzAwMjcz#n#NjU4NTYwNTI2OTM4NzI4ODcxNjE5MTMwNzQzNzU4NzE4NDAyMjg0NTE5MTc2MjA1#n#OTkxMTY1NDgwNjY5Nzc5Njk1MzAwNjQ3MjAwODA5NTIxNTk4MzY3NjU5NjIxNTE0#n#NTU1OTkyODUxNTAyNzg0MTczMzY5NjU5NzA1MTcyNjc2ODM3MjI5NTM1MjU3NDUx#n#Mjg0Mjg4NzAzMTk0NTM5OTY4MzE4NzI3MDMyMDQ2MTkzOA==#,000004,01,999902,CHANNEL_ID_UNCONTROLLED,p1,NTU3NzI3MTQ4OTUxNzY0OTAxMjI3NzcxNzM0NDc0NDY3NzA5NDM1OTg0MTY5ODA5#n#NjQzMjk3NDQxMDYzMTE3NDUxNzcxMDY1NTI3NTY4NzM2ODg0MDczOTI0MDM1MzAy#n#ODM5NzEwNjcyMzU4ODczMTg4MzI4MzQ4ODUzMjkwODE5NzM1NDk1MTA1OTM2Mjkw#n#MDM5NzU1MzMwMzE0NjIwMDA0MzA5MTkwMDg2NzQzMDMzNTg5NDkzOTk5NjUwOTM5#n#MDQ1OTg3NjgxMTQ4Mjc2MTUwNTYwMjE3MTk1MjU1NDgyNzQ4MjY5NjgxODU1MTE4#n#MDI4NzkzMjYxMzA2NzA0MzcxMDcxMzQ5NzY1NTE1Mzg4Mjk3MTEwMjA0NzM2NjIz#n#MjM1NzQwMTc0NTc1NTc3NjUxMDIwMTYzMzI4ODg2MjYyNDY0NDU5ODc2NDkxOTQy#n#NDQ1NjUwOTQwNDk5NDA3OTk5ODQ3MzcyNzUzOTkxNDUxMzUyNzk3NjI1MTE1NDMy#n#NTg1OTI3MzMwNzYyMTg4NDI5MDUyMDMzNzk4MzQyMjY0ODYxMDkxMzE5MjgxNjk1#n#NDk3OTA0MTkyNjU0MTcxNTg1NjYzNzg1OTIzNTQ4NjAyNzIwNjM0NDQxMTQzNjMx#n#NzM5OTk4ODM1Njc1OTM3NTQwMjc2Njc0NDQ4MjAwNjIzNDIzMDIxOTQ5NDMzOTI1#n#NzI1Mjc5MDkzMzU4MjQwMTgzNjg1NzcwNDk0MTM3MDA3MzI5MzE0Nzk3MjczMjcz#n#Njg2ODE1MzQwNDExNTE2MTkwMTY2NjI3MTQ4OTI2MDUzNTYzNDU5M3w4MjE3NTc1#n#ODk3OTc0ODYzNjg2ODY0OTk2MDE3NjMyMTA0MzI4MTM1NzE5NzYxNDc2NTI1Njg1#n#MTMxODk5Mjg2MTcyMTAwOTU1ODYxMTIzODc3NzQ1NDk1NzU4ODM0NDcyNDU5ODE0#n#Mzk4NTg4NTE2MTQ2MzcyMDA1Nzk4NjcyMDUwNzU5Njc2MjUyMjk1NDYzNDE3MTQ2#n#NjE5NjE4Njg4MDY5OTA3OTYzMDMwMTUyMzUxNzEwMDE2NDc4ODk4NTI5NjMyODQ3#n#MTkzNzg0OTg5MjMyNjI2OTA5MjMyNTg4MjE1NjUwMTY1Njk5NTY0NDcwOTc1OTQz#n#ODEzODgwMDQ5OTM2ODgwNzcyMTk3MDUwMDM2NTc1MDI4NzU5MjE1OTIxODk0MTQy#n#NjcyNjY4MTE1Mjg4MzUxNTk2MTA5ODg5MjAwNTY4OTc1NDc3MzE3MjA2NzY1NTcx#n#MzA3Mjk3MTk3NjgwNjUxOTg2Mjk1ODM4MDY2MDEyNzI0Mjk3OTI0MDgzNDcwNzI5#n#NzI1MzcxMzI5Mzc4OTYzNzA2OTQzNDg3NzQ3NDMxNTgxMDEzNjU3NTI5MDIxNDcw#n#MjgwNzMxNzE4Mzg4NjU5NTYzMzIwOTczNjcxNDY4OTYzMDczMzQ2MjI2NjQ5OTMz#n#ODIxNDAxODQ2MzA0ODE3NTg0NzM4MzM4MTAxNzEyNjc5OTczMzUwOTk0Mzg0Mjc3#n#OTM0OTg0NjA3ODIwMjIzNjY0MDMxNjUyNTAzMzcxMTk2ODk1NzE1MDQ4NTg2MTk5#n#MDcwNzY3MDE5NzA2MDIxMTEzNzEzNjU4OTg4MTEyMzY1#,000004,01,999902,CHANNEL_ID_UNCONTROLLED,p1,OTkxNDcwMjA5MjgwMjE2NjQ4NTY0MDAzMDQ3MDUyODk2NzQyMzEwMDA5MTQzODQ0#n#NTQyNTAxOTY1OTA1OTE5NTE5MDE1NjEzNjEyMDI1NDQzNTQ4MDM0Nzg5OTM1NjM4#n#MTE3MTQwMDY3NTYzODU3NDAxODU2MzIzNjM3NDcxNTAyNDk0ODk1MDE5OTcwNTgz#n#NjU3MzA4MDU1MTU2ODY3NDQyMTQxNDgyNTAwNDE1NDY0NjMyNDg0MjcwMzEyOTY2#n#ODk0NDk2OTgxMTU4Mzc1ODI4NDA4ODkzMDg5MzIwODI5Njk5MTAxNjExNzM4OTUz#n#NzY3MTI2MjE5OTgyMzI3NTI5MjMxMzA0OTE5NTk2NjczOTQ4MTA1MzQ1NjgzNTg0#n#NDk3OTIxNzU3MDkzOTcxNDIyNzUzNjk0MzcyNTIzMDg4MDk0Nzc3MTQ3MDYxMDA4#n#NTI0NjY5ODUwMTYyOTEwNjEyNTk4MTI1MTYzODU2MjgxNTYwOTYwMDYzNDEzMjM0#n#NDQxMzQ5MTc4NTMwNTYwMTk4MTUyNDExODA2MjEzMTA5MTc3MjAxODExOTcyMzIz#n#MDQ3MzY3OTQ5MzMyOTc0Mjc3NDIyMDYxNzg2NjAzNzkzNTE5NjM1Njc4NzI2NDI3#n#MDI1Nzk1Nzk3OTEzMTA0MjMzNjAwNjQ0NDQ1NTM0MjgyMzEwMzcwMjQzNzMwMjQ5#n#NDkzMDAwNzg1MjkyNzIwMDA2NDUzOTgyNTY1MjU2OTc4NTcyNjMyNDMyNzAxNjQ2#n#MzUzMTU1NTMyNTAzMzE4OTgxMzk5NTUyNjE1ODU1NzQ1NjE3OTIxOHwxNjIzNDYw#n#NzU3NjE4NDg5ODM5MzE5ODg2MTg2Njc4OTA5Njg2MTI2NTgyMjc4NDgwNzc0OTE5#n#Nzg0MTk2NzQwODg5MjIxNDIzMzQxOTY1OTg1Mjg3MTMxNzMxOTQwNzgyMjYyNDI3#n#MDE0MjM0MzMyNjQxNjcxNTk4MDc1Nzg2MjM5MzkwNDk5MzUwNjE2NzgyNDA1ODA1#n#Mjk3ODQ5MzkxOTYzOTAyMDcyMjUzNDg1NzkyMDMyNTAzODg3MDE2ODU3NzI4NDkz#n#NjEyODc3NTY1ODc0NzIyMjA2NDQ0NjcyNzE1NDU5MTI3NDY2ODAzNTAzMTYyMjY5#n#Mjk5NTU5NDM3MjA3Njc0OTI5NzY0ODcwNjU4MDEwNDYzNjMzMDc0ODEyMDY4MTA2#n#MTk2MDMwMTc3NjQ5NzIwMjc2MDE5NDg1MTY0Nzc0MjQyMTc0OTU0MTE5NjU5MTcy#n#MzQzMzU1NDU3MjM3MTIwNjAwMDUyMzE2NjEwNzQ5ODE5NzAzMzA5ODk0ODIyNTIy#n#NjkyNTE2NDI3MjIwNTc4MDcxMDM2NzQ2MDY3MDA5Nzk2OTQ0NzAyNjk4OTk3MDg5#n#OTU5MzM1NTIzMzMxOTEwMzc5NDc5NTMyMjA1NDIwOTYyMjIzMDU5NjAyMjQzMzU1#n#NTQ0MzAzNjIxMjYxNTgwMzk3MjM3NzQ1NTI5NTA5MDQwODY4NTYzMzY3MDUxNjkw#n#ODk5NTI5NzMyMDM1NjE2NjY5NTI0NzI0OTA0ODc1OTgxMDcwNDEwNjk4MjY4MjEw#n#NTM1NDA3NDQ0NDE2OTgxNzUxMjkzNjA0NDI1OTMyMjM0Mw==#,000004,01,999902,CHANNEL_ID_UNCONTROLLED,p1".getBytes();

    private static final byte[] SAMPLE_INCORRECT_OUTPUT_VOTES = "NTIzODc2NDM3NDEwODYxODY0MTI1NzQ3MDcyNTMxOTM4ODI4MzcxNTI4NjI3MjU5#n#Mzg0Nzc5ODE0NjAzMTI1NjkxODM5MTg1NzUyMjg5OTM5Mjc1Mjg3MjY1NzU2NTQ5#n#MTcxNjYzODI5MDkwNDkzODUyNjM5MzYxNjY3NjY2NjQyNjExODUxNTc1MDg3MDcw#n#Mzc5MjE5MDk1NDY0MTc5MDY4NzAzMDc3Mzc2ODEwMDg4NTkzMzMyMDQ0OTg0MjIy#n#MDYwOTg5MzI2NjMxOTcyNzcxODU2MTE0MTA5MzI4MjM4MDkxNjM1MDk2OTUwMDE3#n#NDUzMzA2OTYyNTk4NzQ3OTk1MDMzNDc2MDc2NTE0MzE0MjgzMDIzNDY0NzcyOTk3#n#ODczMDk2MTU1MTUyNDAyODU3MjE3MDk2NTk5MDQwODI4OTQxNDk2NDg5MjU5NDk3#n#MzE4MDYyNjI3MDY5MTQ1MjgxMjkyNDI4NzcxNzk4NjY4NTM3ODk0MDU5MDg4MzA2#n#NDUxNjAzMzkwMjY4NTg1ODk3MTU2NTE4MTczNDkwNTc5NjM2NTQ3MTA3MDUxMjgy#n#NzY2Mjk0MDEwOTk1MzkwMDU5ODU5NTA3MzM0OTIyODgzMzA1NzkwNjQ4NDExMTUy#n#MjU1ODczOTcwMzI5NzE1OTY5MTc4MjE3NzIxMTI3MzIxMjIxOTQxNjc4NDI5MzM0#n#MjM1NDEwMTg1ODM4MTI1MTQ4NzIwNjgxODQ1MzY1MzgwOTM5MzE1MDM2NzI1NzM5#n#NjExNjg5MzM0NTk4MDIzMjQ5Mzg1NTUyMjgzNDY4OTQzNTY5MzYyMzJ8ODY5OTM0#n#MDc5NDYyMDAyODUwNTEyODQyMjMxNDI4MzUyNjI3NzE1MTc4MzcwMDEwMzg5MTQ5#n#MzQxNjQzNjI1MjYwNDUwMjk3Mjc3Nzg1NDIxMjQwMTI5NzkzNzQ3OTU3NjUzMjQy#n#MTg4MzU4NzU2ODc4NjU1MDUxMTMyODU0NjIyODkyNDEwODgyODM5MTUwOTczNjA1#n#Njk4MTg0NjU2NTM2NDM5NzUzMjUzOTA3NjUxNjM4ODg0NDM0OTE1NDMzNzM3MDIw#n#MDM0ODEyMzkzOTc4NzU3NjQ1MTA5MDkxNjM4ODU1ODc1OTg5NDQ3MDI5MjI5MTky#n#MjYwNjQxMDQyOTk3NjUxNjAzODQ3OTMzMTYyMTUzMzY4MTkwNDU2OTcxNTI2MzA0#n#NzgxMjcwODQyODY2MzA2MDU4MzQ0MTMxNzAyNjkwNjc5ODUyNDIxNDM4MTg3MDg1#n#Njc1ODk1NzQ2MTMyMTcwMDE3MTY5Mzc2NTA4MzA2MTk1NDg1Nzk5NjUxNDUzMzI0#n#NDQwMzkwNTg4MzAyOTQ2NDUxNDg0NzU1MDA1NjMyMTM3Mjc5MzI5Nzc2MzAwMjcz#n#NjU4NTYwNTI2OTM4NzI4ODcxNjE5MTMwNzQzNzU4NzE4NDAyMjg0NTE5MTc2MjA1#n#OTkxMTY1NDgwNjY5Nzc5Njk1MzAwNjQ3MjAwODA5NTIxNTk4MzY3NjU5NjIxNTE0#n#NTU1OTkyODUxNTAyNzg0MTczMzY5NjU5NzA1MTcyNjc2ODM3MjI5NTM1MjU3NDUx#n#Mjg0Mjg4NzAzMTk0NTM5OTY4MzE4NzI3MDMyMDQ2MTkzOA==#,000004,01,999902,CHANNEL_ID_UNCONTROLLED,p1\nNTU3NzI3MTQ4OTUxNzY0OTAxMjI3NzcxNzM0NDc0NDY3NzA5NDM1OTg0MTY5ODA5#n#NjQzMjk3NDQxMDYzMTE3NDUxNzcxMDY1NTI3NTY4NzM2ODg0MDczOTI0MDM1MzAy#n#ODM5NzEwNjcyMzU4ODczMTg4MzI4MzQ4ODUzMjkwODE5NzM1NDk1MTA1OTM2Mjkw#n#MDM5NzU1MzMwMzE0NjIwMDA0MzA5MTkwMDg2NzQzMDMzNTg5NDkzOTk5NjUwOTM5#n#MDQ1OTg3NjgxMTQ4Mjc2MTUwNTYwMjE3MTk1MjU1NDgyNzQ4MjY5NjgxODU1MTE4#n#MDI4NzkzMjYxMzA2NzA0MzcxMDcxMzQ5NzY1NTE1Mzg4Mjk3MTEwMjA0NzM2NjIz#n#MjM1NzQwMTc0NTc1NTc3NjUxMDIwMTYzMzI4ODg2MjYyNDY0NDU5ODc2NDkxOTQy#n#NDQ1NjUwOTQwNDk5NDA3OTk5ODQ3MzcyNzUzOTkxNDUxMzUyNzk3NjI1MTE1NDMy#n#NTg1OTI3MzMwNzYyMTg4NDI5MDUyMDMzNzk4MzQyMjY0ODYxMDkxMzE5MjgxNjk1#n#NDk3OTA0MTkyNjU0MTcxNTg1NjYzNzg1OTIzNTQ4NjAyNzIwNjM0NDQxMTQzNjMx#n#NzM5OTk4ODM1Njc1OTM3NTQwMjc2Njc0NDQ4MjAwNjIzNDIzMDIxOTQ5NDMzOTI1#n#NzI1Mjc5MDkzMzU4MjQwMTgzNjg1NzcwNDk0MTM3MDA3MzI5MzE0Nzk3MjczMjcz#n#Njg2ODE1MzQwNDExNTE2MTkwMTY2NjI3MTQ4OTI2MDUzNTYzNDU5M3w4MjE3NTc1#n#ODk3OTc0ODYzNjg2ODY0OTk2MDE3NjMyMTA0MzI4MTM1NzE5NzYxNDc2NTI1Njg1#n#MTMxODk5Mjg2MTcyMTAwOTU1ODYxMTIzODc3NzQ1NDk1NzU4ODM0NDcyNDU5ODE0#n#Mzk4NTg4NTE2MTQ2MzcyMDA1Nzk4NjcyMDUwNzU5Njc2MjUyMjk1NDYzNDE3MTQ2#n#NjE5NjE4Njg4MDY5OTA3OTYzMDMwMTUyMzUxNzEwMDE2NDc4ODk4NTI5NjMyODQ3#n#MTkzNzg0OTg5MjMyNjI2OTA5MjMyNTg4MjE1NjUwMTY1Njk5NTY0NDcwOTc1OTQz#n#ODEzODgwMDQ5OTM2ODgwNzcyMTk3MDUwMDM2NTc1MDI4NzU5MjE1OTIxODk0MTQy#n#NjcyNjY4MTE1Mjg4MzUxNTk2MTA5ODg5MjAwNTY4OTc1NDc3MzE3MjA2NzY1NTcx#n#MzA3Mjk3MTk3NjgwNjUxOTg2Mjk1ODM4MDY2MDEyNzI0Mjk3OTI0MDgzNDcwNzI5#n#NzI1MzcxMzI5Mzc4OTYzNzA2OTQzNDg3NzQ3NDMxNTgxMDEzNjU3NTI5MDIxNDcw#n#MjgwNzMxNzE4Mzg4NjU5NTYzMzIwOTczNjcxNDY4OTYzMDczMzQ2MjI2NjQ5OTMz#n#ODIxNDAxODQ2MzA0ODE3NTg0NzM4MzM4MTAxNzEyNjc5OTczMzUwOTk0Mzg0Mjc3#n#OTM0OTg0NjA3ODIwMjIzNjY0MDMxNjUyNTAzMzcxMTk2ODk1NzE1MDQ4NTg2MTk5#n#MDcwNzY3MDE5NzA2MDIxMTEzNzEzNjU4OTg4MTEyMzY1#,000004,01,999902,CHANNEL_ID_UNCONTROLLED,p1\nOTkxNDcwMjA5MjgwMjE2NjQ4NTY0MDAzMDQ3MDUyODk2NzQyMzEwMDA5MTQzODQ0#n#NTQyNTAxOTY1OTA1OTE5NTE5MDE1NjEzNjEyMDI1NDQzNTQ4MDM0Nzg5OTM1NjM4#n#MTE3MTQwMDY3NTYzODU3NDAxODU2MzIzNjM3NDcxNTAyNDk0ODk1MDE5OTcwNTgz#n#NjU3MzA4MDU1MTU2ODY3NDQyMTQxNDgyNTAwNDE1NDY0NjMyNDg0MjcwMzEyOTY2#n#ODk0NDk2OTgxMTU4Mzc1ODI4NDA4ODkzMDg5MzIwODI5Njk5MTAxNjExNzM4OTUz#n#NzY3MTI2MjE5OTgyMzI3NTI5MjMxMzA0OTE5NTk2NjczOTQ4MTA1MzQ1NjgzNTg0#n#NDk3OTIxNzU3MDkzOTcxNDIyNzUzNjk0MzcyNTIzMDg4MDk0Nzc3MTQ3MDYxMDA4#n#NTI0NjY5ODUwMTYyOTEwNjEyNTk4MTI1MTYzODU2MjgxNTYwOTYwMDYzNDEzMjM0#n#NDQxMzQ5MTc4NTMwNTYwMTk4MTUyNDExODA2MjEzMTA5MTc3MjAxODExOTcyMzIz#n#MDQ3MzY3OTQ5MzMyOTc0Mjc3NDIyMDYxNzg2NjAzNzkzNTE5NjM1Njc4NzI2NDI3#n#MDI1Nzk1Nzk3OTEzMTA0MjMzNjAwNjQ0NDQ1NTM0MjgyMzEwMzcwMjQzNzMwMjQ5#n#NDkzMDAwNzg1MjkyNzIwMDA2NDUzOTgyNTY1MjU2OTc4NTcyNjMyNDMyNzAxNjQ2#n#MzUzMTU1NTMyNTAzMzE4OTgxMzk5NTUyNjE1ODU1NzQ1NjE3OTIxOHwxNjIzNDYw#n#NzU3NjE4NDg5ODM5MzE5ODg2MTg2Njc4OTA5Njg2MTI2NTgyMjc4NDgwNzc0OTE5#n#Nzg0MTk2NzQwODg5MjIxNDIzMzQxOTY1OTg1Mjg3MTMxNzMxOTQwNzgyMjYyNDI3#n#MDE0MjM0MzMyNjQxNjcxNTk4MDc1Nzg2MjM5MzkwNDk5MzUwNjE2NzgyNDA1ODA1#n#Mjk3ODQ5MzkxOTYzOTAyMDcyMjUzNDg1NzkyMDMyNTAzODg3MDE2ODU3NzI4NDkz#n#NjEyODc3NTY1ODc0NzIyMjA2NDQ0NjcyNzE1NDU5MTI3NDY2ODAzNTAzMTYyMjY5#n#Mjk5NTU5NDM3MjA3Njc0OTI5NzY0ODcwNjU4MDEwNDYzNjMzMDc0ODEyMDY4MTA2#n#MTk2MDMwMTc3NjQ5NzIwMjc2MDE5NDg1MTY0Nzc0MjQyMTc0OTU0MTE5NjU5MTcy#n#MzQzMzU1NDU3MjM3MTIwNjAwMDUyMzE2NjEwNzQ5ODE5NzAzMzA5ODk0ODIyNTIy#n#NjkyNTE2NDI3MjIwNTc4MDcxMDM2NzQ2MDY3MDA5Nzk2OTQ0NzAyNjk4OTk3MDg5#n#OTU5MzM1NTIzMzMxOTEwMzc5NDc5NTMyMjA1NDIwOTYyMjIzMDU5NjAyMjQzMzU1#n#NTQ0MzAzNjIxMjYxNTgwMzk3MjM3NzQ1NTI5NTA5MDQwODY4NTYzMzY3MDUxNjkw#n#ODk5NTI5NzMyMDM1NjE2NjY5NTI0NzI0OTA0ODc1OTgxMDcwNDEwNjk4MjY4MjEw#n#NTM1NDA3NDQ0NDE2OTgxNzUxMjkzNjA0NDI1OTMyMjM0Mw==#,000004,01,999902,CHANNEL_ID_UNCONTROLLED,p1\n".getBytes();
    private static final String SAMPLE_AUDIT_UUID = "050ec7482895429dbae04688bf22fa57";
    private static final byte[] SAMPLE_INPUT_VOTE_GROUPS = Base64.decodeBase64(
            "rO0ABXNyAEZjb20uc2N5dGwuZXZvdGUucHJvdG9jb2wuaW50ZWdyYXRpb24ubWl4aW5nLmJhc2UuVm90ZUdyb3VwQWZmaWxpYXRpb25zaaNW0vQmEAwCAAFMAA5fdm90ZUdyb3VwQWZmc3QAEkxqYXZhL3V0aWwvVmVjdG9yO3hwc3IAEGphdmEudXRpbC5WZWN0b3LZl31bgDuvAQMAA0kAEWNhcGFjaXR5SW5jcmVtZW50SQAMZWxlbWVudENvdW50WwALZWxlbWVudERhdGF0ABNbTGphdmEvbGFuZy9PYmplY3Q7eHAAAAAAAAAAA3VyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAApzcgARamF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFuZy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAAAHEAfgAKcQB+AApwcHBwcHBweA==");
    private static final byte[] SAMPLE_OUTPUT_VOTE_GROUPS = Base64.decodeBase64(
            "rO0ABXNyAEZjb20uc2N5dGwuZXZvdGUucHJvdG9jb2wuaW50ZWdyYXRpb24ubWl4aW5nLmJhc2UuVm90ZUdyb3VwQWZmaWxpYXRpb25zaaNW0vQmEAwCAAFMAA5fdm90ZUdyb3VwQWZmc3QAEkxqYXZhL3V0aWwvVmVjdG9yO3hwc3IAEGphdmEudXRpbC5WZWN0b3LZl31bgDuvAQMAA0kAEWNhcGFjaXR5SW5jcmVtZW50SQAMZWxlbWVudENvdW50WwALZWxlbWVudERhdGF0ABNbTGphdmEvbGFuZy9PYmplY3Q7eHAAAAAAAAAAA3VyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAApzcgARamF2YS5sYW5nLkludGVnZXIS4qCk94GHOAIAAUkABXZhbHVleHIAEGphdmEubGFuZy5OdW1iZXKGrJUdC5TgiwIAAHhwAAAAAHEAfgAKcQB+AApwcHBwcHBweA==");
    private static final byte[] SAMPLE_REENCRYPTION_PROOFS = Base64.decodeBase64(
            "rO0ABXNyAENjb20uc2N5dGwuZXZvdGUucHJvdG9jb2wuaW50ZWdyYXRpb24ubWl4aW5nLmJhc2UuUmVFbmNyeXB0aW9uUHJvb2ZzTD/h4+Cu7VUCAAFMAAxfcmVFbmNQcm9vZnN0ABJMamF2YS91dGlsL1ZlY3Rvcjt4cHNyABBqYXZhLnV0aWwuVmVjdG9y2Zd9W4A7rwEDAANJABFjYXBhY2l0eUluY3JlbWVudEkADGVsZW1lbnRDb3VudFsAC2VsZW1lbnREYXRhdAATW0xqYXZhL2xhbmcvT2JqZWN0O3hwAAAAAAAAAAF1cgATW0xqYXZhLmxhbmcuT2JqZWN0O5DOWJ8QcylsAgAAeHAAAAAKc3IAMWNvbS5zY3l0bC5ldm90ZS5wcm90b2NvbC5zaWduZXJzLlNjaG5vcnJTaWduYXR1cmVyhXVPyxEF7wIAA0wAAl9ldAAWTGphdmEvbWF0aC9CaWdJbnRlZ2VyO0wAAl9zcQB+AAlMAAZfc0NvbGxxAH4AAXhwc3IAFGphdmEubWF0aC5CaWdJbnRlZ2VyjPyfH6k7+x0DAAZJAAhiaXRDb3VudEkACWJpdExlbmd0aEkAE2ZpcnN0Tm9uemVyb0J5dGVOdW1JAAxsb3dlc3RTZXRCaXRJAAZzaWdudW1bAAltYWduaXR1ZGV0AAJbQnhyABBqYXZhLmxhbmcuTnVtYmVyhqyVHQuU4IsCAAB4cP///////////////v////4AAAABdXIAAltCrPMX+AYIVOACAAB4cAAAAQCyZBrcGpvOeCwe8rsEN5U8js2wjnruLacDJnHdw6KsKXFew33wq1mVn/ZAEnbl7M32T5a49L7OYdicRXGGliU+VyKy3Kd2SEULtk5xXuRvCZZOXs54D8Dv379IgaE2iUkZcGyYw/vI1hm+66eYKNlAmSpr5Kz+R7PceANcLYwYRKeeqVI/n+gupw41rVJBauruGUOMrHAfpjLCgFLJblox/3EUfusJt2D9dqIrR4FBo7aJOHHbbWUgbApTAG2ecf72Xr6xJ5C8t6xcm37hACLH1dDLSXPlw3YoMUl5shKkFecOhgMTB1S20Zs1lh09DwGUK0CgOQ1SGzFLS3hK//h6eHNxAH4AC////////////////v////7/////dXEAfgAPAAACAHjZVH/Ubk5Fy/dVu/QRqiK5/JQ56goBgt1gmyrRlMx3SVCQE2wNFufkVg/JwwByCZf0nI6UxuIwUyXYmWeQabQ94xIHHWqLyWsZgi2D6hV2BpTuGdjek+hZb+ywwzolKhnl2BZCIN9R/s5kYet8/SZS0Kj+/Su9YFEYehsNabb0ocA245cFTg7IyqOZ7T+aXcljoXGQpYSGJsyLqubx5oDaB8W6RhZyJLo79H4RoYRhuvyY4sEu7rdFCKNg5jtXX0IuaCr8LpgbWk2BF3pmreg0aITd0/owacDuVUxgQ5qyK3ryUGLhgY0mQvClogxGXEeMcZd/SVGzbWuD4Sww6anSZcc/iZ+WxuBdN7c9nV1AgOoMBcED8hDPpjRxjSMg2nziUQlzgwC0lCZPVXmsJfTWtEfdvdcShhsqW4aZKNib7sZnZejtUB+NQ63wozkMwKhheNXbaYgnhNOXgi3PBVPOI60a6Xq3pSjkzAKuob0ftinYWJkPb36MBk+WYTGqHNVtuiZkJoKfdpN/kBeIAJxsa54JB/2l5mLcUcAC0EH1uuvIP6YEKsLWFmhXEn6/lQy+uYm6EJdmogFsq8effKgXEsoo5gv7NR8oa8J76Z24bq75RYpKkatqY93UV+CN9yJ29BdB2brY5l0hEU/fz1Wn+PuQzmvST7BHvEZzVWrReHBwcHBwcHBwcHB4");
    private static final byte[] SAMPLE_INVALID_FIELD = "Foo".getBytes();
    private com.computas.zkpev2013.mixing.MixingVerificationWorker worker;
    private ResultsList results;

    /**
     * Creates a results list and a worker to run the tests against.
     * @param results
     */
    @BeforeMethod
    public void createResultsAndWorker() {
        results = new ResultsArrayList();
        worker = new com.computas.zkpev2013.mixing.MixingVerificationWorker(results,
                SAMPLE_P, SAMPLE_G, new ElGamalPublicKeyList(SAMPLE_H));
    }

    /**
     * Verifies that an incident is created if the input votes are
     * corrupt.
     * @throws java.security.NoSuchAlgorithmException Should not be thrown.
     */
    @Test
    public void mustCreateAnInvalidMixingDataRecordIncidentIfInputVotesInvalid()
        throws NoSuchAlgorithmException {
        worker.setMixingData(SAMPLE_MIXING_UUID, SAMPLE_INVALID_FIELD,
            SAMPLE_OUTPUT_VOTES);
        worker.setAuditData(SAMPLE_AUDIT_UUID, SAMPLE_INPUT_VOTE_GROUPS,
            SAMPLE_OUTPUT_VOTE_GROUPS, SAMPLE_REENCRYPTION_PROOFS);
        worker.tryToRun();
        assertTrue(results.contains(
                new InvalidMixingDataRecordIncident(SAMPLE_MIXING_UUID,
                    InvalidMixingDataRecordIncident.INPUT_VOTES_INVALID)));
    }

    /**
     * Verifies that an incident is created if the output votes are
     * corrupt.
     * @throws java.security.NoSuchAlgorithmException Should not be thrown.
     */
    @Test
    public void mustCreateAnInvalidMixingDataRecordIncidentIfOutputVotesInvalid()
        throws NoSuchAlgorithmException {
        worker.setMixingData(SAMPLE_MIXING_UUID, SAMPLE_INPUT_VOTES,
            SAMPLE_INVALID_FIELD);
        worker.setAuditData(SAMPLE_AUDIT_UUID, SAMPLE_INPUT_VOTE_GROUPS,
            SAMPLE_OUTPUT_VOTE_GROUPS, SAMPLE_REENCRYPTION_PROOFS);
        worker.tryToRun();
        assertTrue(results.contains(
                new InvalidMixingDataRecordIncident(SAMPLE_MIXING_UUID,
                    InvalidMixingDataRecordIncident.OUTPUT_VOTES_INVALID)));
    }

    /**
     * Verifies that an incident is created if the input and output votes are
     * corrupt.
     * @throws java.security.NoSuchAlgorithmException Should not be thrown.
     */
    @Test
    public void mustCreateTwoInvalidMixingDataRecordIncidentsIfInputAndOutputVotesInvalid()
        throws NoSuchAlgorithmException {
        worker.setMixingData(SAMPLE_MIXING_UUID, SAMPLE_INVALID_FIELD,
            SAMPLE_INVALID_FIELD);
        worker.setAuditData(SAMPLE_AUDIT_UUID, SAMPLE_INPUT_VOTE_GROUPS,
            SAMPLE_OUTPUT_VOTE_GROUPS, SAMPLE_REENCRYPTION_PROOFS);
        worker.tryToRun();

        boolean hasInvalidInputVotesIncident = results.contains(new InvalidMixingDataRecordIncident(
                    SAMPLE_MIXING_UUID,
                    InvalidMixingDataRecordIncident.INPUT_VOTES_INVALID));
        boolean hasInvalidOutputVotesIncident = results.contains(new InvalidMixingDataRecordIncident(
                    SAMPLE_MIXING_UUID,
                    InvalidMixingDataRecordIncident.OUTPUT_VOTES_INVALID));
        assertTrue(hasInvalidInputVotesIncident &&
            hasInvalidOutputVotesIncident);
    }

    /**
     * Verifies that an incident is created if the input vote groups is
     * corrupt.
     */
    @Test
    public void mustCreateAnInvalidAuditDataRecordIncidentIfInputVoteGroupsInvalid() {
        worker.setAuditData(SAMPLE_AUDIT_UUID, SAMPLE_INVALID_FIELD,
            SAMPLE_OUTPUT_VOTE_GROUPS, SAMPLE_REENCRYPTION_PROOFS);
        assertTrue(results.contains(
                new InvalidAuditDataRecordIncident(SAMPLE_AUDIT_UUID,
                    InvalidAuditDataRecordIncident.INPUT_VOTE_GROUPS_INVALID)));
    }

    /**
     * Verifies that an incident is created if the output vote groups is
     * corrupt.
     */
    @Test
    public void mustCreateAnInvalidAuditDataRecordIncidentIfOutputVoteGroupsInvalid() {
        worker.setAuditData(SAMPLE_AUDIT_UUID, SAMPLE_INPUT_VOTE_GROUPS,
            SAMPLE_INVALID_FIELD, SAMPLE_REENCRYPTION_PROOFS);
        assertTrue(results.contains(
                new InvalidAuditDataRecordIncident(SAMPLE_AUDIT_UUID,
                    InvalidAuditDataRecordIncident.OUTPUT_VOTE_GROUPS_INVALID)));
    }

    /**
     * Verifies that an incident is created if the reencryption proofs are
     * corrupt.
     */
    @Test
    public void mustCreateAnInvalidAuditDataRecordIncidentIfReencryptionProofsInvalid() {
        worker.setAuditData(SAMPLE_AUDIT_UUID, SAMPLE_INPUT_VOTE_GROUPS,
            SAMPLE_OUTPUT_VOTE_GROUPS, SAMPLE_INVALID_FIELD);
        assertTrue(results.contains(
                new InvalidAuditDataRecordIncident(SAMPLE_AUDIT_UUID,
                    InvalidAuditDataRecordIncident.REENCRYPTION_PROOFS_INVALID)));
    }

    /**
     * Verifies that an incident is created if a proof is incorrect.
     * @throws java.security.NoSuchAlgorithmException Should not be thrown.
     */
    @Test
    public void mustCreateAnIncorrectMixingProofIncidentIfAProofIsIncorrect()
        throws NoSuchAlgorithmException {
        worker.setMixingData(SAMPLE_MIXING_UUID, SAMPLE_INPUT_VOTES,
            SAMPLE_INCORRECT_OUTPUT_VOTES);
        worker.setAuditData(SAMPLE_AUDIT_UUID, SAMPLE_INPUT_VOTE_GROUPS,
            SAMPLE_OUTPUT_VOTE_GROUPS, SAMPLE_REENCRYPTION_PROOFS);
        worker.tryToRun();
        assertTrue(results.contains(
                new IncorrectMixingProofIncident(SAMPLE_MIXING_UUID,
                    SAMPLE_AUDIT_UUID, 0)));
    }

    /**
     * Verifies that no incident is created if all proofs are correct.
     * @throws java.security.NoSuchAlgorithmException Should not be thrown.
     */
    @Test
    public void mustNotCreateAnIncorrectMixingProofIncidentIfAllProofsAreCorrect()
        throws NoSuchAlgorithmException {
        worker.setMixingData(SAMPLE_MIXING_UUID, SAMPLE_INPUT_VOTES,
            SAMPLE_OUTPUT_VOTES);
        worker.setAuditData(SAMPLE_AUDIT_UUID, SAMPLE_INPUT_VOTE_GROUPS,
            SAMPLE_OUTPUT_VOTE_GROUPS, SAMPLE_REENCRYPTION_PROOFS);
        worker.tryToRun();
        assertFalse(results.contains(
                new IncorrectMixingProofIncident(SAMPLE_MIXING_UUID,
                    SAMPLE_AUDIT_UUID, 0)));
    }
}
